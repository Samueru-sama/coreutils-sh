#!/bin/sh

unset uid whoami

_version() {
	echo "$0 (coreutils-sh) devel"
	exit 0
}

_help() {
	echo "Usage: $0 [OPTION]..."
	echo "Print the user name associated with the current effective user ID."
	echo "Same as id -un."
	echo ""
	echo "      --help        display this help and exit"
	echo "      --version     output version information and exit"
	exit 0
}

_error() {
	>&2 echo "$*"
	>&2 echo "Try '$0 --help' for more information."
	exit 1
}

_get_current_uid() {
	while IFS="" read -r line; do
		set -- $line
		if [ "$1" = "Uid:" ]; then
			uid="$2"
			break
		fi
	done < /proc/self/status

	if [ -n "$uid" ]; then
		return 0
	else
		_error "$0: cannot determine uid"
	fi
}

_whoami() {
	while IFS="" read -r line; do
		IFS=:; set -- $line
		if [ "$3" = "$uid" ]; then
			whoami="$1"
			break
		fi
	done < /etc/passwd

	if [ -n "$whoami" ]; then
		echo "$whoami"
		exit 0
	else
		_error "$0: unknown uid $uid"
	fi
}

while :; do case "$1" in
	--)         shift; break;;
	--help)     _help;;
	--version)  _version;;
	-*)         _error "$0: invalid option -- '$1'";;
	*)         break;;
	esac
done

if [ -n "$1" ]; then
	_error "$0: extra operand '$1'"
fi

_get_current_uid
_whoami

