#!/bin/sh

unset del

_version() {
	echo "devel"
	exit 0
}

_help() {
	echo "Usage: $0 [OPTION]..."
	echo "Print the number of processing units available to the current process,"
	echo "which may be less than the number of online processors"
	echo "      --all      print the number of installed processors"
	echo "      --ignore N  if possible, exclude N processing units"
	echo "      --help        display this help and exit"
	echo "      --version     output version information and exit"
	exit 0
}

_error() {
	>&2 echo "$*"
	>&2 echo "Try '$0 --help' for more information."
	exit 1
}

_ignore() {
	if [ -z "$2" ]; then
		_error "$0: option '$1' requires an argument"
	fi
	del=$2
}

_nproc() {
	count=0
	while IFS="" read -r line; do
		case "$line" in
			processor*:*)
				count=$(( count + 1 ))
				;;
		esac
	done < /proc/cpuinfo

	if [ -n "$del" ]; then
		count=$(( count - del ))
		if [ "$count" -lt 1 ]; then
			count=1
		fi
	fi

	echo "$count"
}

while :; do case "$1" in
	--)         shift; break;;
	--help)     _help;;
	--version)  _version;;
	--ignore)   _ignore "$@"; shift; shift;;
	-*)         _error "$0: invalid option -- '$1'";;
	*)          break;;
	esac
done

if [ -n "$1" ]; then
	_error "$0: extra operand '$1'"
fi

_nproc
